@using MS.Katusha.Domain.Entities
@using MS.Katusha.Enumerations
@model MS.Katusha.Web.Models.MessagesModel
@{
    Layout = "";
    var controller = ViewContext.RouteData.Values["Controller"];
    var profile = ViewBag.KatushaProfile as Profile;
    var items = Model.Conversations;
    var statistics = Model.Statistics;
    var messageType = Model.MessageType;
}
@if(statistics != null) {
    if(statistics.UnreadCount > 0) {<text>@statistics.UnreadCount unread messages /</text>}
    <text>@statistics.Count messages</text>
}
</h3>
<script type="text/javascript">
    function readM(guid) {
        $.post('/Messages/Read', {key:guid}).done(function (json) {
            json = json || {};
            $('#M' + guid).text(json.message).slideDown('slow');
            $('#showReply').slideDown('fast');
        });
    }
</script>       
<ul>
@foreach (var message in items.List) {
    if (message == null) { continue; }
    var name = (messageType == MessageType.Sent) ? message.ToName : message.FromName;
    var profileGuid = (messageType == MessageType.Sent) ? message.ToGuid : message.FromGuid;
    var photoGuid = (messageType == MessageType.Sent) ? message.ToPhotoGuid : message.FromPhotoGuid;
    var isRead = (message.FromId == profile.Id) || (message.ReadDate != new DateTime(1900, 1, 1));
    var canClickRead = (messageType == MessageType.Received);    
    <li style="list-style: none; border:1px solid #f0f0f0">
        <table>
            <tr>
                <td style="width:50px; overflow: hidden"><a href="@Url.Action("Show", "Profiles", new {key=profileGuid})">@Html.Photo(photoGuid, PhotoType.Icon)<br /><span class="username">@name</span></a></td>
                <td style="background-color: #ffe; width: 100%">
                    <table width="100%">
                        <tr><td style="background-color: goldenrod;"><span title="@message.CreationDate.ToLongDateString()">@Html.GetFriendlyDate(message.CreationDate)</span></td></tr>
                        <tr><td style="background-color: gold;font-weight: bold;">
                                <a href="#" title="Read" onclick="@((canClickRead && !isRead)?"readM('"+message.Guid+"')":"void()")">@(String.IsNullOrWhiteSpace(message.Subject) ? "[No Subject]" : message.Subject)</a><br/>
                            </td>
                        </tr>
                        <tr><td>
                            <div id="M@(message.Guid)" class="@((canClickRead && !isRead) ? "hide" : "")">
                                @if(!(canClickRead && !isRead)) {
<text>@(message.Message)</text>
                                }
                            </div>
                            <br/>
                            <div id="showReply" class="@((!(canClickRead && !isRead)) ? "" : "hide")">
                                <a class="btn btn-warning cancel" id="sendMessageButton" data_dialog_title="Send Message" href='@Url.Action("Send", "Messages", new {key = profileGuid, subject = message.Subject})' title="Reply to this message">Reply</a>
                            </div>
                        </td></tr>
                    </table>
                </td>
            </tr>
        </table>
    </li>
}
</ul>

@if (Model.Conversations.Total > Model.Conversations.List.PageSize) {
    <hr style="clear: both"/>
    @Html.PagedListPager(Model.Conversations.List, key => Url.Action("List", new { key = key }), PagedListRenderOptions.OnlyShowFivePagesAtATime)
}

